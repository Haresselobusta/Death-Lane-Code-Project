using System.Collections;
using System.Collections.Generic;
using UnityEngine;

[System.Serializable]
public class ZombieType
{
    [Header("RandomZombie")]
    public GameObject prefab;
    [Range(0, 100)] public float baseChance;
    [Range(0, 100)] public float maxChance;
}

public class ZombieSpawner : MonoBehaviour
{
    [Header("Spawn Area")]
    public Transform topPoint;
    public Transform bottomPoint;
    public Transform spawnPoint;

    [Header("Dynamic Spawn Settings")]
    private float minSpawnInterval = 0.6f;
    private float maxSpawnInterval = 2f;
    private float difficultyIncreaseRate = 0.8f;

    private float difficultyProgress = 0f;
    private float spawnTimer;

    [Header("Zombie Settings")]
    public List<ZombieType> zombies = new List<ZombieType>();

    private void Start()
    {
        spawnTimer = Random.Range(minSpawnInterval, maxSpawnInterval);
    }

    private void Update()
    {
        if (GameManager.Instance.isGameOver) return;

        difficultyProgress += (difficultyIncreaseRate * 0.25f) * Time.deltaTime;
        difficultyProgress = Mathf.Clamp01(difficultyProgress);

        float currentInterval = Mathf.Lerp(maxSpawnInterval, minSpawnInterval, difficultyProgress);
        currentInterval *= Random.Range(0.8f, 1.2f);

        spawnTimer -= Time.deltaTime;
        if (spawnTimer <= 0f)
        {
            SpawnZombie();
            spawnTimer = currentInterval;
        }
    }

    void SpawnZombie()
    {
        if (zombies.Count == 0) return;

        // var zomtores. = float Converted to int by rounding up
        int zombiesToSpawn = 1;

        for (int i = 0; i < zombiesToSpawn; i++)
        {
            float randomY = Random.Range(bottomPoint.position.y, topPoint.position.y);
            float randomXOffset = Random.Range(0f, 1f);

            Vector3 spawnPos = new Vector3(spawnPoint.position.x + randomXOffset, randomY, spawnPoint.position.z);
            GameObject zombieToSpawn = GetRandomZombie();
            Instantiate(zombieToSpawn, spawnPos, Quaternion.identity);
        }
    }

    GameObject GetRandomZombie()
    {
        float totalWeight = 0f;
        List<float> adjustedChances = new List<float>();

        foreach (var number in zombies)
        {
            float adjustedChance = Mathf.Lerp(number.baseChance, number.maxChance, difficultyProgress);
            adjustedChances.Add(adjustedChance);
            totalWeight += adjustedChance;
        }

        float randomValue = Random.Range(0, totalWeight);
        float cumulative = 0f;

        for (int i = 0; i < zombies.Count; i++)
        {
            cumulative += adjustedChances[i];
            if (randomValue <= cumulative)
                return zombies[i].prefab;
        }

        return zombies[0].prefab;

    }

}